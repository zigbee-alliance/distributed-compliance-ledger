---
# Copyright 2022
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Check Tests and Documentation
# yamllint disable-line rule:truthy
on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
      - issue-99-cosmos-upgrade-v0.44
  workflow_dispatch:

jobs:
  changes:
    name: Check for changes
    runs-on: ubuntu-latest
    outputs:
      go: ${{ steps.filter.outputs.go }}
      src: ${{ steps.filter.outputs.src }}
      docs: ${{ steps.filter.outputs.docs }}
      workflows: ${{ steps.filter.outputs.workflows }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        if: ${{ !env.ACT }}
        id: filter
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          filters: |
            go:
              - '**/*.go'
              - 'go.mod'
              - 'go.sum'
            src:
              - '!((**.md)|(**/*.md)|(.github/**)|(docs/**)|(vue/**))'
            docs:
              - '**.md'
              - '**/*.md'
            workflows:
              - '.github/**'
  gh-actions:
    if: needs.changes.outputs.workflows == 'true'
    name: Run actionlint tool to verify lint issues in GitHub actions
    runs-on: ubuntu-latest
    needs:
      - changes
    steps:
      - uses: actions/checkout@master
      - uses: reviewdog/action-actionlint@v1
  links:
    if: needs.changes.outputs.docs == 'true'
    name: Run markdown-link-check tool to verify link issues
    runs-on: ubuntu-latest
    needs:
      - changes
    steps:
      - uses: actions/checkout@v4
      - uses: gaurav-nelson/github-action-markdown-link-check@v1
  spell:
    if: needs.changes.outputs.docs == 'true'
    name: Run PySpelling tool to verify spelling issues
    runs-on: ubuntu-latest
    needs:
      - changes
    steps:
      - uses: actions/checkout@v4
      - uses: rojopolis/spellcheck-github-actions@0.35.0
  unit-tests:
    name: Check unit tests
    runs-on: ubuntu-latest
    needs:
      - lint
    steps:
      - uses: actions/setup-go@v5
        with:
          go-version: ^1.20
      - uses: actions/checkout@v4
      - uses: actions/cache@v4
        if: ${{ !env.ACT }}
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      - uses: haveyoudebuggedit/gotestfmt-action@v2
      - name: Run tests
        run: |
          set -euo pipefail
          # shellcheck disable=SC2046
          go test -json -v $(go list ./... | grep -v '/integration_tests') -coverprofile=./cover.out -covermode=set -coverpkg=./... 2>&1 | tee /tmp/gotest.log | gotestfmt
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
      - name: Store test coverage
        uses: actions/upload-artifact@v4
        with:
          name: unit_cover
          path: cover.out
  integration-tests:
    if: needs.changes.outputs.src == 'true'
    name: Integration tests
    runs-on: ubuntu-22.04
    needs:
      - changes
    steps:
      - uses: actions/setup-go@v5
        with:
          go-version: ^1.20
      - uses: actions/checkout@v4
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      - name: Run integration tests
        shell: bash
        run: integration_tests/run-all.sh all cover
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
      - name: Generate test coverage
        shell: bash
        run: go tool covdata textfmt -i=integration_tests/gocover -o cover.out
      - name: Store test coverage
        uses: actions/upload-artifact@v4
        with:
          name: integration_cover
          path: cover.out
  lint:
    if: needs.changes.outputs.go == 'true'
    name: Check linter issues with golangci-lint tool
    runs-on: ubuntu-latest
    needs:
      - changes
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: 1.21
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: v1.55
          args: --timeout 5m0s
  cover:
    if: needs.changes.outputs.src == 'true'
    name: Report on overall test coverage
    needs:
      - changes
      - unit-tests
      - integration-tests
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ^1.20
      - name: Gocovmerge build
        shell: bash
        run: go build github.com/wadey/gocovmerge
      - name: Merge test coverage
        shell: bash
        run: ./gocovmerge unit_cover/cover.out integration_cover/cover.out > cover.out
      - name: Filter test coverage
        shell: bash
        run: .github/workflows/filter_coverage.sh
      - name: Report test coverage
        uses: vladopajic/go-test-coverage@v2
        continue-on-error: true
        with:
          config: ./.github/.testcoverage.yml
          git-token: ${{ github.ref_name == 'main' && secrets.GITHUB_TOKEN || '' }}
          git-branch: cover_badges
      - name: Generate html test coverage
        shell: bash
        run: go tool cover -html=cover.out -o cover.html
      - name: Upload html coverage
        uses: actions/upload-artifact@v4
        with:
          name: test_coverage
          path: |
            cover.html
            cover.out
      - uses: geekyeggo/delete-artifact@v5
        with:
          name: |
            integration_cover
            unit_cover
  check:
    if: always()
    needs:
      - unit-tests
      - integration-tests
      - lint
      - links
      - spell
      - gh-actions
      - cover
    runs-on: ubuntu-latest
    steps:
      - name: Decide whether the needed jobs succeeded or failed
        uses: re-actors/alls-green@release/v1
        with:
          allowed-skips: lint, unit-tests, integration-tests, links, spell, gh-actions
          jobs: ${{ toJSON(needs) }}
